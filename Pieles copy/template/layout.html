<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{#home}}{{title}}{{/home}}</title> 
 
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="{{assets}}/application.js"></script>
    
    <link rel='stylesheet' href='{{assets}}/style.css' type='text/css' /> 
    <link rel="icon" href="{{assets}}/favicon.ico" type="image/vnd.microsoft.icon" /> 
    
    <!-- lightbox -->
    <script type="text/javascript" src="{{assets}}/jquery-lightbox/js/jquery.lightbox-0.5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{assets}}/jquery-lightbox/css/jquery.lightbox-0.5.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="{{assets}}/jquery-lightbox/css/custom.css" media="screen" />
    
    
    <script>      
      var element_width = 100;
      var element_height = 140;
      var images = [];
      var thumbs = [];
      var n = 0;
      var lattice_width = 0;
      var lattice_height = 0;
      var lattice = new Array();
      var lattice_x = 0;
      var lattice_y = 0;
      var lattice_step_x = 0;
      var lattice_step_y = 0;
      var lattice_rows = 0;
      var lattice_columns = 0;
      var min_box = 200;
      var max_step = 400;
      
      var lattice_velocity_relax = 100;
      var milliseconds_step = 20;
    
      $( function(){
        {{#home}}
          {{#elements}}
            images[n] = "{{jpg}}";
            thumbs[n] = "{{jpg_thumb}}";
            n++;
          {{/elements}}
        {{/home}}
        
        createLattice();
        activateLightbox();
        loadImages();
        
        $(document).mousemove( function( e ){
          window_center_x = $('#content').width() / 2;
          window_center_y = $('#content').height() / 2;
          
          if( Math.abs( window_center_x - e.pageX ) > min_box ) {
            lattice_step_x = (window_center_x - e.pageX) / lattice_velocity_relax;
          } else {
            lattice_step_x = 0;
          }
          
          if( Math.abs( window_center_y - e.pageY ) > min_box ) {
            lattice_step_y = (window_center_y - e.pageY) / lattice_velocity_relax;
          } else {
            lattice_step_y = 0;
          }
        });
        
        moveLattice( 0, 0 );
        renderControls();
      });
      
      function activateLightbox(){
        $('.element a').lightBox({
          imageLoading:  '{{assets}}/jquery-lightbox/images/lightbox-ico-loading.gif',
          imageBtnPrev:  '{{assets}}/jquery-lightbox/images/lightbox-btn-prev.gif',
          imageBtnNext:  '{{assets}}/jquery-lightbox/images/lightbox-btn-next.gif',
          imageBtnClose: '{{assets}}/jquery-lightbox/images/lightbox-btn-close.gif',
          imageBlank:    '{{assets}}/jquery-lightbox/images/lightbox-blank.gif'
        });
      }
      
      function createLattice(){
        lattice_rows = 10;
        lattice_columns = Math.ceil( images.length / 10 );
        
        for( var i = 0; i < images.length; i++ ) {
          $('#sublattice_left').append( '<div id="element_' + i + '" class="element"><a href="' + images[i] + '"><img src="' + thumbs[i] + '" /></a></div>' );
          $('#sublattice_right').append( '<div id="element_' + i + '" class="element"><a href="' + images[i] + '"><img src="' + thumbs[i] + '" /></a></div>' );
        }
        
        lattice_width = ( lattice_columns * element_width );
        lattice_height = ( lattice_rows * element_height );
        
        $('.sublattice').css( 'width', lattice_width + 'px' );
        $('.sublattice').css( 'height', lattice_height + 'px' );
        $('#lattice').css( 'width', (lattice_width * 2) + 'px' );
        $('#lattice').css( 'height', lattice_height + 'px' );
        
        lattice_x = -( (lattice_width - $('#content').width()) / 2 );
        lattice_y = -( (lattice_height - $('#content').height()) / 2 );
        
        $('#lattice').css( 'left', lattice_x + 'px' );
        $('#lattice').css( 'top', lattice_y + 'px' );
      }
      
      function loadImages(){
        thumbs_unordered = thumbs.sort( Math.round( Math.random() ) - 0.5 );
        
        for( var i = 0; i < thumbs_unordered.length; i++ ) {
          var thumb_object = new Image();
          thumb_object.src = thumbs_unordered[i];
          
          ( function() {
            var element_id = i;
            $( thumb_object ).load( function() {
              $('#element_' + element_id + ' img').fadeIn();
            });            
          })();

        }
      }
      
      function renderControls(){
        $('#lattice_x').val( lattice_x );
        $('#lattice_y').val( lattice_y );
        $('#lattice_width').val( lattice_width );
        $('#lattice_height').val( lattice_height );
      }
      
      function moveLattice( x_inc, y_inc ){
        lattice_x += x_inc;
        lattice_y += y_inc;
        
        if( lattice_x > 0 ) {
          lattice_x -= lattice_width;
          $('#lattice').css( 'left', (lattice_x - x_inc) + 'px' );
        }
        
        if( lattice_x < -lattice_width ) {
          lattice_x += lattice_width;
          $('#lattice').css( 'left', (lattice_x - x_inc) + 'px' );
        }
        
        if( lattice_y > 0 ) {
          lattice_y = 0;
        }
        
        if( lattice_y < -(lattice_height - $('#content').height()) ) {
          lattice_y = -(lattice_height - $('#content').height());
        }
        
        $('#lattice').animate( 
          { 
            left: lattice_x + "px",
            top: lattice_y + "px"
          }, 
          milliseconds_step,
          'linear',
          function(){ moveLattice( lattice_step_x, lattice_step_y ) } 
        );
        
        renderControls();
      }

      
      
    </script>
  </head>  
  <body> 
    <div id="container">   
      <div id="controls">
        <ul>
          <li>lattice_x: <input type="text" id="lattice_x" /></li>
          <li>lattice_y: <input type="text" id="lattice_y" /></li>
          <li>lattice_width: <input type="text" id="lattice_width" /></li>
          <li>lattice_height: <input type="text" id="lattice_height" /></li>
          <li><input type="button" id="left" value="left" onclick="moveLattice( 100, 100 )" /></li>
          <li><input type="button" id="right" value="right" onclick="moveLattice( -100, -100 )" /></li>
        </ul>
      </div>
      <div id="content"> 
        <div id="lattice">
          <div id="sublattice_left" class="sublattice"></div>
          <div id="sublattice_right" class="sublattice"></div>
        </div>
      </div> <!-- content -->
    </div> <!-- container --> 
  </body> 
</html>